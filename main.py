import logging, os
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

from config import BOT_TOKEN, CHANNEL_LINK, DEVELOPER_ID

logging.basicConfig(level=logging.INFO)

bot = Bot(BOT_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot, storage=MemoryStorage())

# ===== STATES =====
class FileFlow(StatesGroup):
    waiting_text = State()
    waiting_name = State()
    waiting_format = State()

# ===== KEYBOARDS =====
def main_kb():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("ğŸ“ Text â†’ File", "ğŸŒ Translate Text")
    kb.add("ğŸ“¢ Channel", "ğŸ‘¨â€ğŸ’» Developer")
    return kb

def format_kb():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("ğŸ“„ TXT", callback_data="txt"),
        types.InlineKeyboardButton("ğŸ PY", callback_data="py"),
        types.InlineKeyboardButton("ğŸŒ HTML", callback_data="html"),
        types.InlineKeyboardButton("ğŸ§© JSON", callback_data="json"),
    )
    return kb

# ===== START =====
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    name = message.from_user.first_name
    await message.answer(
f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’€ <b>TEXT TO FILES GENERATOR BOT</b> ğŸ’€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‘ Welcome <b>{name}</b>

â¤ Paste text  
â¤ Name your file  
â¤ Choose format  

â From idea to file â€” instantly â âš¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
reply_markup=main_kb()
)

# ===== MAIN MENU =====
@dp.message_handler(lambda m: m.text == "ğŸ“¢ Channel")
async def channel(message: types.Message):
    await message.answer(CHANNEL_LINK)

@dp.message_handler(lambda m: m.text == "ğŸ‘¨â€ğŸ’» Developer")
async def dev(message: types.Message):
    await message.answer(f"ğŸ‘¨â€ğŸ’» Developer: {DEVELOPER_ID}")

# ===== TEXT â†’ FILE FLOW =====
@dp.message_handler(lambda m: m.text == "ğŸ“ Text â†’ File")
async def text_to_file(message: types.Message):
    await message.answer(
"âœï¸ <b>Send your text now</b>\n\nâ Write it. Shape it. Build it. â",
reply_markup=types.ReplyKeyboardRemove()
    )
    await FileFlow.waiting_text.set()

@dp.message_handler(state=FileFlow.waiting_text)
async def get_text(message: types.Message, state: FSMContext):
    await state.update_data(text=message.text)
    await message.answer(
"ğŸ“› <b>Send file name</b>\nâ¤ Without extension\nâ¤ Example: <code>index</code>"
    )
    await FileFlow.waiting_name.set()

@dp.message_handler(state=FileFlow.waiting_name)
async def get_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await message.answer(
"ğŸ§© <b>Choose output format</b>",
reply_markup=format_kb()
    )
    await FileFlow.waiting_format.set()

@dp.callback_query_handler(state=FileFlow.waiting_format)
async def make_file(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    text = data["text"]
    name = data["name"]
    ext = call.data

    filename = f"{name}.{ext}"
    with open(filename, "w", encoding="utf-8") as f:
        f.write(
f"# Generated by Text To Files Generator Bot\n"
f"# Developer: {DEVELOPER_ID}\n\n{text}"
        )

    await call.message.answer_document(
        open(filename, "rb"),
        caption=
f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ <b>DONE!</b>

Your file is ready ğŸ“„  
Simple â€¢ Fast â€¢ Reliable  

ğŸ‘¨â€ğŸ’» Developer: {DEVELOPER_ID}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
reply_markup=main_kb()
    )

    os.remove(filename)
    await state.finish()

# ===== RUN =====
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
