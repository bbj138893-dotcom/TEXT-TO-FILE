import logging, os
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher import FSMContext
from aiogram.dispatcher.filters.state import State, StatesGroup

from config import BOT_TOKEN, CHANNEL_LINK, DEVELOPER_ID, BOT_USERNAME, BOT_NAME

logging.basicConfig(level=logging.INFO)

bot = Bot(BOT_TOKEN, parse_mode="HTML")
dp = Dispatcher(bot, storage=MemoryStorage())

# ================= STATES =================
class FileFlow(StatesGroup):
    waiting_text = State()
    waiting_name = State()
    waiting_format = State()

# ================= KEYBOARDS =================
def main_kb():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.add("ğŸ“ Text â†’ File", "ğŸŒ Translate Text")
    kb.add("ğŸ“¢ Channel", "ğŸ‘¨â€ğŸ’» Developer")
    return kb

def format_kb():
    kb = types.InlineKeyboardMarkup(row_width=2)
    kb.add(
        types.InlineKeyboardButton("ğŸ“„ TXT", callback_data="txt"),
        types.InlineKeyboardButton("ğŸ PY", callback_data="py"),
        types.InlineKeyboardButton("ğŸŒ HTML", callback_data="html"),
        types.InlineKeyboardButton("ğŸ§© JSON", callback_data="json"),
    )
    return kb

# ================= START =================
@dp.message_handler(commands=["start"])
async def start(message: types.Message):
    name = message.from_user.first_name
    await message.answer(
f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’€ <b>{BOT_NAME}</b> ğŸ’€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‘ Welcome <b>{name}</b>

â¤ Paste text  
â¤ Name your file  
â¤ Choose format  

â From idea to file â€” instantly â âš¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
reply_markup=main_kb()
)

# ================= CHANNEL =================
@dp.message_handler(lambda m: m.text == "ğŸ“¢ Channel")
async def channel(message: types.Message):
    await message.answer(
"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¢ <b>OFFICIAL CHANNEL</b>

Updates â€¢ Features â€¢ Power tools  
Everything first â€” only here âš¡

ğŸ‘‰ <b>Join now:</b>
https://t.me/PROFESSORXZAMINHACKER
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
disable_web_page_preview=True
)

# ================= DEVELOPER =================
@dp.message_handler(lambda m: m.text == "ğŸ‘¨â€ğŸ’» Developer")
async def developer(message: types.Message):
    await message.answer(f"ğŸ‘¨â€ğŸ’» Developer: {DEVELOPER_ID}")

# ================= TEXT â†’ FILE FLOW =================
@dp.message_handler(lambda m: m.text == "ğŸ“ Text â†’ File")
async def start_file_flow(message: types.Message):
    await FileFlow.waiting_text.set()
    await message.answer(
"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœï¸ <b>SEND YOUR TEXT</b>

â¤ Paste code or normal text  
â¤ No limits â€¢ No filters  

â Words become files here â âš¡
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
reply_markup=types.ReplyKeyboardRemove()
)

@dp.message_handler(state=FileFlow.waiting_text)
async def get_text(message: types.Message, state: FSMContext):
    await state.update_data(text=message.text)
    await FileFlow.waiting_name.set()
    await message.answer(
"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“› <b>SEND FILE NAME</b>

â¤ Without extension  
â¤ Example: <code>index</code>

â Name it. Own it. â
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
)

@dp.message_handler(state=FileFlow.waiting_name)
async def get_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text)
    await FileFlow.waiting_format.set()
    await message.answer(
"ğŸ§© <b>CHOOSE OUTPUT FORMAT</b>",
reply_markup=format_kb()
)

@dp.callback_query_handler(state=FileFlow.waiting_format)
async def generate_file(call: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    text = data["text"]
    name = data["name"]
    ext = call.data

    filename = f"{name}.{ext}"

    with open(filename, "w", encoding="utf-8") as f:
        f.write(
f"""# Generated by {BOT_NAME}
# Bot: {BOT_USERNAME}
# Developer: {DEVELOPER_ID}

{text}
"""
        )

    await call.message.answer_document(
        open(filename, "rb")
    )

    await call.message.answer(
f"""â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‰ <b>FILE CREATED SUCCESSFULLY</b>

Your file is ready & delivered ğŸ“  
Clean â€¢ Accurate â€¢ Ready to use  

ğŸ” Want to create another file?

â¤ Click ğŸ“ Text â†’ File  
â¤ Send new text  
â¤ Name the file  
â¤ Choose format  

â One idea. Unlimited files. â âš¡

ğŸ‘¨â€ğŸ’» Developer: {DEVELOPER_ID}
ğŸ¤– Bot: {BOT_USERNAME}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
""",
reply_markup=main_kb()
    )

    os.remove(filename)
    await state.finish()

# ================= RUN =================
if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
